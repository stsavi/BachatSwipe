<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Card Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="cards_data.js"></script>

    <style>
        body { background-color: #0b1121; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; transition: 0.2s; }
        .input-dark:focus { border-color: #f59e0b; outline: none; }
        .gold-glow { border: 1px solid #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.15); background: rgba(245, 158, 11, 0.05); }
        
        /* Accordion Animation */
        .strategies-box { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease-out, padding 0.3s ease;
        }
        .strategies-box.open { 
            max-height: 500px; 
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .chevron { transition: transform 0.3s; }
        .chevron.open { transform: rotate(180deg); }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex flex-col items-center">

    <div id="error-banner" class="hidden w-full max-w-4xl bg-red-900/50 border border-red-500 text-red-200 p-4 rounded-xl mb-6 text-center">
        <p class="font-bold"><i class="fas fa-exclamation-triangle"></i> Database Not Found</p>
        <p class="text-sm mt-1">Please ensure <b>cards_data.js</b> is in the same folder.</p>
    </div>

    <div class="w-full max-w-4xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-5xl font-black mb-2 tracking-tight">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-600">Reward Engine 16.0</span>
            </h1>
            <p class="text-slate-400 text-sm">Voucher Aware ‚Ä¢ Smart Search ‚Ä¢ Multi-Path Analysis</p>
        </div>

        <div class="glass p-6 rounded-2xl shadow-xl mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Expense Amount (‚Çπ)</label>
                    <input type="number" id="amount" value="5000" class="input-dark w-full p-3 rounded-lg text-lg font-mono">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Merchant / App</label>
                    <input type="text" id="merchant" list="merchant_list" placeholder="Type to search (e.g. Flipkart)" class="input-dark w-full p-3 rounded-lg" autocomplete="off">
                    <datalist id="merchant_list"></datalist>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Category</label>
                    <select id="category" class="input-dark w-full p-3 rounded-lg border-yellow-500/30">
                        <option value="shopping">Shopping (Online)</option>
                        <option value="upi">UPI / Scan & Pay üì∏</option>
                        <option value="fuel">Fuel / Petrol ‚õΩ</option>
                        <option value="utility">Utility / Bills üí°</option>
                        <option value="dining">Dining / Food üçî</option>
                        <option value="travel">Travel (Flight/Hotel) ‚úàÔ∏è</option>
                        <option value="grocery">Grocery / Offline üõí</option>
                        <option value="wallet">Wallet Load üëõ</option>
                        <option value="rent">Rent / Education üè†</option>
                        <option value="gov">Government / Tax üèõÔ∏è</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-slate-700/50 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="w-full md:w-auto flex-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">
                        <i class="fas fa-credit-card mr-1"></i> Select Card (Optional)
                    </label>
                    <input type="text" id="card_input" list="card_list" placeholder="‚ö° Find Top 10 Cards (Default)" class="input-dark w-full p-2 rounded-lg text-sm border-slate-600 font-bold text-yellow-400 bg-slate-800">
                    <datalist id="card_list"></datalist>
                    <input type="hidden" id="selected_card_id" value="all">
                </div>
                <button onclick="runEngine()" class="w-full md:w-auto px-8 py-3 bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-400 hover:to-orange-500 text-black font-bold rounded-xl shadow-lg transition active:scale-95">
                    Analyze Rewards
                </button>
            </div>
        </div>

        <h2 id="result_title" class="text-xl font-bold text-white mb-4 hidden">Recommendations</h2>
        <div id="results" class="space-y-3"></div>
    </div>

    <script>
    // ------------------------------------------------------------------
    // 1. INIT & POPULATE MENUS (Data Processing)
    // ------------------------------------------------------------------
    window.onload = function() {
        if (typeof ALL_CARDS_DB === 'undefined') {
            document.getElementById('error-banner').classList.remove('hidden');
            return;
        }

        // A. Populate Card Datalist
        const cardList = document.getElementById('card_list');
        const sortedCards = [...ALL_CARDS_DB].sort((a,b) => a.name.localeCompare(b.name));
        
        let allOpt = document.createElement('option');
        allOpt.value = "All Cards (Compare Top 10)";
        cardList.appendChild(allOpt);

        sortedCards.forEach(card => {
            let opt = document.createElement('option');
            opt.value = card.name; // User sees Name
            opt.setAttribute('data-id', card.id); // Code uses ID
            cardList.appendChild(opt);
        });

        // B. Populate Merchant Autocomplete (Clean & Deduped)
        const merchantSet = new Set();
        ALL_CARDS_DB.forEach(card => {
            if (card.rules) {
                card.rules.forEach(rule => {
                    const targets = [...(rule.merchants || []), ...(rule.trigger || []), rule.platform];
                    targets.forEach(t => {
                        if(t) {
                            // Capitalize First Letter (Title Case)
                            const cleanName = t.charAt(0).toUpperCase() + t.slice(1).toLowerCase();
                            merchantSet.add(cleanName);
                        }
                    });
                });
            }
        });

        const sortedMerchants = [...merchantSet].sort();
        const merchList = document.getElementById('merchant_list');
        sortedMerchants.forEach(m => {
            let option = document.createElement('option');
            option.value = m;
            merchList.appendChild(option);
        });

        // C. Handle Card Input Logic (Map Name -> ID)
        document.getElementById('card_input').addEventListener('input', function(e) {
            const val = e.target.value;
            const options = document.getElementById('card_list').childNodes;
            let foundId = "all";
            for (let i = 0; i < options.length; i++) {
                if (options[i].value === val) {
                    foundId = options[i].getAttribute('data-id') || "all";
                    break;
                }
            }
            document.getElementById('selected_card_id').value = foundId;
        });
    };

    function toggleDetails(id) {
        document.getElementById(`strat-${id}`).classList.toggle('open');
        document.getElementById(`chev-${id}`).classList.toggle('open');
    }

    // ------------------------------------------------------------------
    // 2. MAIN ENGINE (With Voucher Calculation & Logic)
    // ------------------------------------------------------------------
    function runEngine() {
        if (typeof ALL_CARDS_DB === 'undefined') return alert("Database Missing!");

        const amount = parseFloat(document.getElementById('amount').value) || 0;
        
        // Inputs
        const rawMerchant = document.getElementById('merchant').value.toLowerCase().trim();
        const merchantInput = rawMerchant.replace(/[^a-z0-9 ]/g, ""); 
        const category = document.getElementById('category').value;
        const selectedId = document.getElementById('selected_card_id').value;
        
        // Smart Category Mapping
        let sysCat = category;
        if (merchantInput.includes("qr") || merchantInput.includes("scan")) sysCat = "upi";
        if (merchantInput.includes("petrol") || merchantInput.includes("pump") || merchantInput.includes("fuel")) sysCat = "fuel";

        const categoryAliases = {
            "shopping": ["shopping", "online", "all"],
            "dining": ["dining", "food", "online", "all"],
            "travel": ["travel", "flight", "hotel", "airline", "online", "all"],
            "utility": ["utility", "bill", "online", "all"],
            "grocery": ["grocery", "offline", "departmental", "all"],
            "fuel": ["fuel", "petrol", "all"],
            "upi": ["upi", "all"],
            "wallet": ["wallet", "all"],
            "rent": ["rent", "all"],
            "gov": ["gov", "all"]
        };
        const validTags = categoryAliases[sysCat] || [sysCat, "all"];

        let groupedResults = {};

        ALL_CARDS_DB.forEach(card => {
            // Filter specific card
            if (selectedId !== "all" && card.id !== selectedId) return;

            // --- A. Base Strategy (The Direct Swipe) ---
            let baseRate = card.base_rate;
            let baseNote = "Direct Swipe (Base Rate)";
            let isExcluded = false;

            // Check exclusions
            if (card.base_exclusions && card.base_exclusions.includes(sysCat)) {
                baseRate = 0;
                baseNote = "Excluded Category";
                isExcluded = true;
            }
            if (sysCat === "upi" && !card.supports_upi) {
                baseRate = 0;
                baseNote = "No UPI Support";
                isExcluded = true;
            }

            let baseVal = amount * baseRate * card.value_inr;

            // Initialize Card Object
            if (!groupedResults[card.id]) {
                groupedResults[card.id] = {
                    cardName: card.name,
                    bank: card.bank,
                    rewardType: card.reward_type,
                    strategies: []
                };
            }

            // Push Base Strategy
            groupedResults[card.id].strategies.push({
                method: "Direct Swipe",
                val: baseVal,
                note: baseNote,
                pct: (baseRate * 100).toFixed(2),
                icon: "üí≥",
                isBase: true
            });

            // --- B. Advanced Strategies (Rules/Vouchers) ---
            if (card.rules) {
                card.rules.forEach(rule => {
                    
                    // --- VOUCHER GATEKEEPER CHECK ---
                    // This logic ensures cards like 'Swiggy HDFC' don't get Voucher suggestions
                    // unless they are explicitly enabled in the DB.
                    if (rule.type === "voucher" && !card.supports_vouchers) {
                        return; 
                    }

                    let match = false;
                    
                    const ruleTargets = [...(rule.merchants || []), ...(rule.trigger || []), rule.platform]
                        .filter(k => k).map(k => k.toLowerCase());

                    // CHECK 1: Merchant Match (Fuzzy & Bidirectional)
                    if (merchantInput && ruleTargets.length > 0) {
                        if (ruleTargets.some(t => t === merchantInput || t.includes(merchantInput) || merchantInput.includes(t))) {
                            match = true;
                        }
                    }

                    // CHECK 2: Category Match (If no merchant match found yet)
                    if (!match && validTags.includes(rule.category)) {
                        if (!rule.merchants && !rule.platform && !rule.trigger) match = true;
                        if ((rule.type === "portal" || rule.type === "voucher") && validTags.includes(rule.category)) match = true;
                    }

                    if (match) {
                        let val = 0;
                        // Calculation Logic
                        if (rule.fixed_pct) {
                            val = amount * rule.fixed_pct;
                        } else if (rule.multiplier) {
                            val = (amount * card.base_rate * rule.multiplier) * card.value_inr;
                        }

                        // Cap Logic
                        if (rule.cap && val > rule.cap) val = rule.cap;

                        let methodLabel = "Direct Boost";
                        let icon = "üöÄ";
                        if (rule.type === "voucher") { methodLabel = "Buy Voucher (Gyftr/Portal)"; icon = "üéüÔ∏è"; }
                        else if (rule.type === "portal") { methodLabel = `Via Portal (${rule.trigger || 'SmartBuy/GrabDeals'})`; icon = "üåê"; }
                        else if (rule.type === "platform") { methodLabel = `Via App (${rule.platform})`; icon = "üì±"; }

                        groupedResults[card.id].strategies.push({
                            method: methodLabel,
                            val: val,
                            note: `${rule.note}`,
                            pct: ((val/amount)*100).toFixed(2),
                            icon: icon
                        });
                    }
                });
            }
        });

        // --- C. Sort & Render ---
        let rankedCards = Object.values(groupedResults).map(item => {
            // Sort strategies High to Low
            item.strategies.sort((a, b) => b.val - a.val);
            return {
                ...item,
                bestStrategy: item.strategies[0],
                allStrategies: item.strategies
            };
        });

        // If 'All Cards' selected, remove those earning 0
        if (selectedId === "all") {
            rankedCards = rankedCards.filter(c => c.bestStrategy.val > 0);
        }

        // Rank Cards by Best Strategy Value
        rankedCards.sort((a, b) => b.bestStrategy.val - a.bestStrategy.val);
        
        renderAccordion(rankedCards.slice(0, 15));
    }

    function renderAccordion(data) {
        const container = document.getElementById('results');
        container.innerHTML = "";
        document.getElementById('result_title').classList.remove('hidden');

        if(data.length === 0) return container.innerHTML = '<div class="text-gray-500 text-center py-4">No rewards found.</div>';

        data.forEach((card, index) => {
            const isWinner = index === 0;
            const best = card.bestStrategy;
            const isCashback = card.rewardType === 'cashback';
            const valueColor = isCashback ? 'text-green-400' : 'text-blue-400';
            
            // Get alternatives (remove the best one from the list)
            const otherStrategies = card.allStrategies.length > 1 ? card.allStrategies.slice(1) : [];

            let subRowsHTML = otherStrategies.map(s => `
                <div class="flex justify-between items-center p-2 text-sm border-b border-white/5 last:border-0 hover:bg-white/5 rounded">
                    <div class="flex items-center gap-2">
                        <span>${s.icon}</span>
                        <div>
                            <div class="text-slate-200 font-medium">${s.method}</div>
                            <div class="text-xs text-slate-500">${s.note}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-white font-mono">‚Çπ${Math.round(s.val)}</div>
                        <div class="text-[10px] text-slate-500">${s.pct}%</div>
                    </div>
                </div>
            `).join('');

            const html = `
                <div class="mb-3 rounded-xl overflow-hidden transition-all duration-300 ${isWinner ? 'bg-slate-800 gold-glow' : 'bg-slate-800/40 border border-slate-700/50'}">
                    
                    <div onclick="toggleDetails(${index})" class="relative p-4 flex justify-between items-center cursor-pointer hover:bg-slate-800/60 transition">
                        ${isWinner ? '<div class="absolute -top-3 -left-2 bg-yellow-500 text-black text-[10px] font-bold px-2 py-0.5 rounded shadow">#1 TOP CHOICE</div>' : ''}
                        
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl shadow-inner">
                                ${best.val > 0 ? (isCashback ? 'üíµ' : 'üíé') : '‚ö†Ô∏è'}
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-lg leading-tight">
                                    ${card.cardName} 
                                    <span class="text-[10px] uppercase bg-slate-900 text-slate-400 px-1.5 py-0.5 rounded ml-1 border border-slate-700">${card.bank}</span>
                                </h3>
                                <div class="text-sm text-gray-300 mt-1 flex items-center gap-1">
                                    <span class="text-xs bg-blue-900/30 text-blue-300 px-1.5 rounded border border-blue-500/20">${best.method}</span>
                                    <span class="text-xs text-slate-500 truncate max-w-[150px] md:max-w-none">‚Ä¢ ${best.note}</span>
                                </div>
                            </div>
                        </div>

                        <div class="text-right flex items-center gap-4">
                            <div>
                                <div class="text-2xl font-bold ${valueColor}">‚Çπ${Math.round(best.val)}</div>
                                <div class="text-xs font-mono text-slate-500 bg-slate-900/50 px-2 py-0.5 rounded inline-block mt-1">
                                    ${best.pct}% Return
                                </div>
                            </div>
                            <i id="chev-${index}" class="fas fa-chevron-down text-slate-600 chevron"></i>
                        </div>
                    </div>

                    <div id="strat-${index}" class="strategies-box bg-slate-900/50 px-4">
                        ${otherStrategies.length > 0 ? `<div class="text-[10px] uppercase font-bold text-slate-600 mb-2">Alternative Payment Methods</div>` : ''}
                        ${subRowsHTML}
                    </div>
                </div>`;
            container.innerHTML += html;
        });
    }
    </script>
</body>
</html>